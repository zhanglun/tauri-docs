(window.webpackJsonp=window.webpackJsonp||[]).push([[128],{205:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return s})),a.d(t,"metadata",(function(){return l})),a.d(t,"toc",(function(){return p})),a.d(t,"default",(function(){return u}));var n=a(3),r=a(7),i=(a(0),a(454)),s={title:"Updater"},l={unversionedId:"usage/guides/updater",id:"usage/guides/updater",isDocsHomePage:!1,title:"Updater",description:"Once you have your Tauri project ready, you need to configure the updater.",source:"@site/docs/zh-hans/usage/guides/updater.md",sourceDirName:"usage/guides",slug:"/usage/guides/updater",permalink:"/zh-hans/docs/usage/guides/updater",editUrl:"https://github.com/tauri-apps/tauri-docs/edit/dev/docs/zh-hans/usage/guides/updater.md",version:"current",frontMatter:{title:"Updater"},sidebar:"docs",previous:{title:"Write Tauri Plugins",permalink:"/zh-hans/docs/usage/guides/plugin"},next:{title:"Icons",permalink:"/zh-hans/docs/usage/guides/visual/icons"}},p=[{value:"Update Requests",id:"update-requests",children:[]},{value:"Built-in dialog",id:"built-in-dialog",children:[]},{value:"Javascript API",id:"javascript-api",children:[]},{value:"Events",id:"events",children:[{value:"Initialize updater and check if a new version is available",id:"initialize-updater-and-check-if-a-new-version-is-available",children:[]},{value:"Rust",id:"rust",children:[]},{value:"Javascript",id:"javascript",children:[]},{value:"Listen New Update Available",id:"listen-new-update-available",children:[]},{value:"Rust",id:"rust-1",children:[]},{value:"Javascript",id:"javascript-1",children:[]},{value:"Emit Install and Download",id:"emit-install-and-download",children:[]},{value:"Rust",id:"rust-2",children:[]},{value:"Javascript",id:"javascript-2",children:[]},{value:"Listen Install Progress",id:"listen-install-progress",children:[]},{value:"Rust",id:"rust-3",children:[]},{value:"Javascript",id:"javascript-3",children:[]}]},{value:"Update Server JSON Format",id:"update-server-json-format",children:[]},{value:"Update File JSON Format",id:"update-file-json-format",children:[]},{value:"macOS",id:"macos",children:[]},{value:"Windows",id:"windows",children:[]},{value:"Linux",id:"linux",children:[]}],o={toc:p};function u(e){var t=e.components,a=Object(r.a)(e,["components"]);return Object(i.b)("wrapper",Object(n.a)({},o,a,{components:t,mdxType:"MDXLayout"}),Object(i.b)("p",null,"Once you have your Tauri project ready, you need to configure the updater."),Object(i.b)("p",null,"Add this in tauri.conf.json"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-json"},'"updater": {\n    "active": true,\n    "endpoints": [\n        "https://releases.myapp.com/{{target}}/{{current_version}}"\n    ],\n    "dialog": true,\n    "pubkey": ""\n}\n')),Object(i.b)("p",null,'The required keys are "active" and "endpoints", others are optional.'),Object(i.b)("p",null,'"active" must be a boolean. By default, it\'s set to false.'),Object(i.b)("p",null,'"endpoints" must be an array. The string ',Object(i.b)("inlineCode",{parentName:"p"},"{{target}}")," and ",Object(i.b)("inlineCode",{parentName:"p"},"{{current_version}}")," are automatically replaced in the URL allowing you determine ",Object(i.b)("a",{parentName:"p",href:"#update-server-json-format"},"server-side")," if an update is available. If multiple endpoints are specified, the updater will fallback if a server is not responding within the pre-defined timeout."),Object(i.b)("p",null,'"dialog" if present must be a boolean. By default, it\'s set to true. If enabled, ',Object(i.b)("a",{parentName:"p",href:"#events"},"events")," are turned-off as the updater will handle everything. If you need the custom events, you MUST turn off the built-in dialog."),Object(i.b)("p",null,'"pubkey" if present must be a valid public-key generated with Tauri cli. See ',Object(i.b)("a",{parentName:"p",href:"#signing-updates"},"Signing updates"),"."),Object(i.b)("h2",{id:"update-requests"},"Update Requests"),Object(i.b)("p",null,"Tauri is indifferent to the request the client application provides for update checking."),Object(i.b)("p",null,Object(i.b)("inlineCode",{parentName:"p"},"Accept: application/json")," is added to the request headers because Tauri is responsible for parsing the response."),Object(i.b)("p",null,"For the requirements imposed on the responses and the body format of an update, response see ",Object(i.b)("a",{parentName:"p",href:"#server-support"},"Server Support"),"."),Object(i.b)("p",null,"Your update request must ",Object(i.b)("em",{parentName:"p"},"at least")," include a version identifier so that the server can determine whether an update for this specific version is required."),Object(i.b)("p",null,"It may also include other identifying criteria such as operating system version, to allow the server to deliver as fine-grained an update as you would like."),Object(i.b)("p",null,"How you include the version identifier or other criteria is specific to the server that you are requesting updates from. A common approach is to use query parameters, ",Object(i.b)("a",{parentName:"p",href:"#configuration"},"Configuration")," shows an example of this."),Object(i.b)("h2",{id:"built-in-dialog"},"Built-in dialog"),Object(i.b)("p",null,"By default, updater uses a built-in dialog API from Tauri."),Object(i.b)("p",null,Object(i.b)("img",{parentName:"p",src:"https://i.imgur.com/UMilB5A.png",alt:"New Update"})),Object(i.b)("p",null,"The dialog release notes is represented by the update ",Object(i.b)("inlineCode",{parentName:"p"},"note")," provided by the ",Object(i.b)("a",{parentName:"p",href:"#server-support"},"server"),"."),Object(i.b)("p",null,"If the user accepts, the download and install are initialized. The user will be then prompted to restart the application."),Object(i.b)("h2",{id:"javascript-api"},"Javascript API"),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Attention, you need to ",Object(i.b)("em",{parentName:"strong"},"disable built-in dialog")," in your ",Object(i.b)("a",{parentName:"strong",href:"#configuration"},"tauri configuration"),", otherwise, events aren't emitted and the javascript API will NOT work.")),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-js"},'import { checkUpdate, installUpdate } from "@tauri-apps/api/updater";\nimport { relaunch } from "@tauri-apps/api/process";\ntry {\n    const {shouldUpdate, manifest} = await checkUpdate();\n    if (shouldUpdate) {\n        // display dialog\n        await installUpdate();\n        // install complete, restart app\n        await relaunch();\n    }\n} catch(error) {\n    console.log(error);\n}\n')),Object(i.b)("h2",{id:"events"},"Events"),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Attention, you need to ",Object(i.b)("em",{parentName:"strong"},"disable built-in dialog")," in your ",Object(i.b)("a",{parentName:"strong",href:"#configuration"},"tauri configuration"),", otherwise, events aren't emitted.")),Object(i.b)("p",null,"To know when an update is ready to be installed, you can subscribe to these events:"),Object(i.b)("h3",{id:"initialize-updater-and-check-if-a-new-version-is-available"},"Initialize updater and check if a new version is available"),Object(i.b)("h4",{id:"if-a-new-version-is-available-the-event-tauriupdate-available-is-emitted"},"If a new version is available, the event ",Object(i.b)("inlineCode",{parentName:"h4"},"tauri://update-available")," is emitted."),Object(i.b)("p",null,"Event: ",Object(i.b)("inlineCode",{parentName:"p"},"tauri://update")),Object(i.b)("h3",{id:"rust"},"Rust"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-rust"},'window.emit("tauri://update".to_string(), None);\n')),Object(i.b)("h3",{id:"javascript"},"Javascript"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-js"},'import { emit } from "@tauri-apps/api/event";\nemit("tauri://update");\n')),Object(i.b)("h3",{id:"listen-new-update-available"},"Listen New Update Available"),Object(i.b)("p",null,"Event: ",Object(i.b)("inlineCode",{parentName:"p"},"tauri://update-available")),Object(i.b)("p",null,"Emitted data:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-none"},"version    Version announced by the server\ndate       Date announced by the server\nbody       Note announced by the server\n")),Object(i.b)("h3",{id:"rust-1"},"Rust"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-rust"},'window.listen("tauri://update-available".to_string(), move |msg| {\n  println!("New version available: {:?}", msg);\n})\n')),Object(i.b)("h3",{id:"javascript-1"},"Javascript"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-js"},'import { listen } from "@tauri-apps/api/event";\nlisten("tauri://update-available", function (res) {\n  console.log("New version available: ", res);\n});\n')),Object(i.b)("h3",{id:"emit-install-and-download"},"Emit Install and Download"),Object(i.b)("p",null,"You need to emit this event to initialize the download and listen to the ",Object(i.b)("a",{parentName:"p",href:"#listen-install-progress"},"install progress"),"."),Object(i.b)("p",null,"Event: ",Object(i.b)("inlineCode",{parentName:"p"},"tauri://update-install")),Object(i.b)("h3",{id:"rust-2"},"Rust"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-rust"},'window.emit("tauri://update-install".to_string(), None);\n')),Object(i.b)("h3",{id:"javascript-2"},"Javascript"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-js"},'import { emit } from "@tauri-apps/api/event";\nemit("tauri://update-install");\n')),Object(i.b)("h3",{id:"listen-install-progress"},"Listen Install Progress"),Object(i.b)("p",null,"Event: ",Object(i.b)("inlineCode",{parentName:"p"},"tauri://update-status")),Object(i.b)("p",null,"Emitted data:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-none"},"status    [ERROR/PENDING/DONE]\nerror     String/null\n")),Object(i.b)("p",null,"PENDING is emitted when the download is started and DONE when the install is complete. You can then ask to restart the application."),Object(i.b)("p",null,"ERROR is emitted when there is an error with the updater. We suggest to listen to this event even if the dialog is enabled."),Object(i.b)("h3",{id:"rust-3"},"Rust"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-rust"},'window.listen("tauri://update-status".to_string(), move |msg| {\n  println!("New status: {:?}", msg);\n})\n')),Object(i.b)("h3",{id:"javascript-3"},"Javascript"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-js"},'import { listen } from "@tauri-apps/api/event";\nlisten("tauri://update-status", function (res) {\n  console.log("New status: ", res);\n});\n')),Object(i.b)("h1",{id:"server-support"},"Server Support"),Object(i.b)("p",null,"Your server should determine whether an update is required based on the ",Object(i.b)("a",{parentName:"p",href:"#update-requests"},"Update Request")," your client issues."),Object(i.b)("p",null,"If an update is required your server should respond with a status code of ",Object(i.b)("a",{parentName:"p",href:"http://tools.ietf.org/html/rfc2616#section-10.2.1"},"200 OK")," and include the ",Object(i.b)("a",{parentName:"p",href:"#update-server-json-format"},"update JSON")," in the body. To save redundantly downloading the same version multiple times your server must not inform the client to update."),Object(i.b)("p",null,"If no update is required your server must respond with a status code of ",Object(i.b)("a",{parentName:"p",href:"http://tools.ietf.org/html/rfc2616#section-10.2.5"},"204 No Content"),"."),Object(i.b)("h2",{id:"update-server-json-format"},"Update Server JSON Format"),Object(i.b)("p",null,"When an update is available, Tauri expects the following schema in response to the update request provided:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-json"},'{\n    "url": "https://mycompany.example.com/myapp/releases/myrelease.tar.gz",\n    "version": "0.0.1",\n    "notes": "Theses are some release notes",\n    "pub_date": "2020-09-18T12:29:53+01:00",\n    "signature": ""\n}\n')),Object(i.b)("p",null,'The only required keys are "url" and "version", the others are optional.'),Object(i.b)("p",null,'"pub_date" if present must be formatted according to ISO 8601.'),Object(i.b)("p",null,'"signature" if present must be a valid signature generated with Tauri cli. See ',Object(i.b)("a",{parentName:"p",href:"#signing-updates"},"Signing updates"),"."),Object(i.b)("h2",{id:"update-file-json-format"},"Update File JSON Format"),Object(i.b)("p",null,"The alternate update technique uses a plain JSON file meaning you can store your update metadata on S3, gist, or another static file store. Tauri will check against the name/version field and if the version is smaller than the current one and the platform is available, the update will be triggered. The format of this file is detailed below:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-json"},'{\n    "name":"v1.0.0",\n    "notes":"Test version",\n    "pub_date":"2020-06-22T19:25:57Z",\n    "platforms": {\n        "darwin": {\n            "signature":"",\n            "url":"https://github.com/lemarier/tauri-test/releases/download/v1.0.0/app.app.tar.gz"\n        },\n        "linux": {\n            "signature":"",\n            "url":"https://github.com/lemarier/tauri-test/releases/download/v1.0.0/app.AppImage.tar.gz"\n        },\n        "win64": {\n            "signature":"",\n            "url":"https://github.com/lemarier/tauri-test/releases/download/v1.0.0/app.x64.msi.zip"\n        }\n    }\n}\n')),Object(i.b)("h1",{id:"bundler-artifacts"},"Bundler (Artifacts)"),Object(i.b)("p",null,"The Tauri bundler will automatically generate update artifacts if the updater is enabled in ",Object(i.b)("inlineCode",{parentName:"p"},"tauri.conf.json")),Object(i.b)("p",null,"If the bundler can locate your private and pubkey, your update artifacts will be automatically signed."),Object(i.b)("p",null,"The signature can be found in the ",Object(i.b)("inlineCode",{parentName:"p"},"sig")," file. The signature can be uploaded to GitHub safely or made public as long as your private key is secure."),Object(i.b)("p",null,"You can see how it's ",Object(i.b)("a",{parentName:"p",href:"https://github.com/tauri-apps/tauri/blob/5b6c7bb6ee3661f5a42917ce04a89d94f905c949/.github/workflows/artifacts-updater.yml#L44"},"bundled with the CI")," and a ",Object(i.b)("a",{parentName:"p",href:"https://github.com/tauri-apps/tauri/blob/5b6c7bb6ee3661f5a42917ce04a89d94f905c949/examples/updater/src-tauri/tauri.conf.json#L52"},"sample tauri.conf.json")),Object(i.b)("h2",{id:"macos"},"macOS"),Object(i.b)("p",null,"On MACOS we create a .tar.gz from the whole application. (.app)"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-none"},"target/release/bundle\n\u2514\u2500\u2500 osx\n    \u2514\u2500\u2500 app.app\n    \u2514\u2500\u2500 app.app.tar.gz (update bundle)\n    \u2514\u2500\u2500 app.app.tar.gz.sig (if signature enabled)\n")),Object(i.b)("h2",{id:"windows"},"Windows"),Object(i.b)("p",null,"On Windows we create a .zip from the MSI, when downloaded and validated, we run the MSI install."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-none"},"target/release\n\u2514\u2500\u2500 app.x64.msi\n\u2514\u2500\u2500 app.x64.msi.zip (update bundle)\n\u2514\u2500\u2500 app.x64.msi.zip.sig (if signature enabled)\n")),Object(i.b)("h2",{id:"linux"},"Linux"),Object(i.b)("p",null,"On Linux, we create a .tar.gz from the AppImage."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-none"},"target/release/bundle\n\u2514\u2500\u2500 appimage\n    \u2514\u2500\u2500 app.AppImage\n    \u2514\u2500\u2500 app.AppImage.tar.gz (update bundle)\n    \u2514\u2500\u2500 app.AppImage.tar.gz.sig (if signature enabled)\n")),Object(i.b)("h1",{id:"signing-updates"},"Signing updates"),Object(i.b)("p",null,"We offer a built-in signature to ensure your update is safe to be installed."),Object(i.b)("p",null,"To sign your updates, you need two things."),Object(i.b)("p",null,"The ",Object(i.b)("em",{parentName:"p"},"Public-key")," (pubkey) should be added inside your ",Object(i.b)("inlineCode",{parentName:"p"},"tauri.conf.json")," to validate the update archive before installing."),Object(i.b)("p",null,"The ",Object(i.b)("em",{parentName:"p"},"Private key")," (privkey) is used to sign your update and should NEVER be shared with anyone. Also, if you lost this key, you'll NOT be able to publish a new update to the current user base (if pubkey is set in tauri.conf.json). It's important to save it at a safe place and you can always access it."),Object(i.b)("p",null,"To generate your keys you need to use the Tauri cli."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-bash"},"tauri sign -g -w ~/.tauri/myapp.key\n")),Object(i.b)("p",null,"You have multiple options available"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-bash"},"Tauri updates signer.\nUSAGE:\n    tauri sign [FLAGS] [OPTIONS]\nFLAGS:\n        --force          Overwrite private key even if it exists on the specified path\n    -g, --generate       Generate keypair to sign files\n    -h, --help           Prints help information\n        --no-password    Set empty password for your private key\n    -V, --version        Prints version information\nOPTIONS:\n    -p, --password <password>                    Set private key password when signing\n    -k, --private-key <private-key>              Load the private key from a string\n    -f, --private-key-path <private-key-path>    Load the private key from a file\n        --sign-file <sign-file>                  Sign the specified file\n    -w, --write-keys <write-keys>                Write private key to a file\n")),Object(i.b)("hr",null),Object(i.b)("p",null,"Environment variables used to sign with the Tauri ",Object(i.b)("inlineCode",{parentName:"p"},"bundler"),":\nIf they are set, and ",Object(i.b)("inlineCode",{parentName:"p"},"tauri.conf.json")," expose the public key, the bundler will automatically generate and sign the updater artifacts.\n",Object(i.b)("inlineCode",{parentName:"p"},"TAURI_PRIVATE_KEY"),"  Path or String of your private key\n",Object(i.b)("inlineCode",{parentName:"p"},"TAURI_KEY_PASSWORD"),"  Your private key password (optional)"))}u.isMDXComponent=!0},454:function(e,t,a){"use strict";a.d(t,"a",(function(){return c})),a.d(t,"b",(function(){return h}));var n=a(0),r=a.n(n);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function s(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?s(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):s(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function p(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var o=r.a.createContext({}),u=function(e){var t=r.a.useContext(o),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},c=function(e){var t=u(e.components);return r.a.createElement(o.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},b=r.a.forwardRef((function(e,t){var a=e.components,n=e.mdxType,i=e.originalType,s=e.parentName,o=p(e,["components","mdxType","originalType","parentName"]),c=u(a),b=n,h=c["".concat(s,".").concat(b)]||c[b]||d[b]||i;return a?r.a.createElement(h,l(l({ref:t},o),{},{components:a})):r.a.createElement(h,l({ref:t},o))}));function h(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var i=a.length,s=new Array(i);s[0]=b;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l.mdxType="string"==typeof e?e:n,s[1]=l;for(var o=2;o<i;o++)s[o]=a[o];return r.a.createElement.apply(null,s)}return r.a.createElement.apply(null,a)}b.displayName="MDXCreateElement"}}]);